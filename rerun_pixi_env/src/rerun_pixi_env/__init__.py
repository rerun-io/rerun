"""Pixi environment setup utilities for Rerun."""

from __future__ import annotations

import os
import shutil
import subprocess
import sys
from pathlib import Path


def get_pixi_project_root() -> Path:
    """Get the PIXI_PROJECT_ROOT, or fail if not set."""
    root = os.environ.get("PIXI_PROJECT_ROOT")
    if not root:
        print("ERROR: PIXI_PROJECT_ROOT not set", file=sys.stderr)
        sys.exit(1)
    return Path(root)


def get_scripts_dir() -> Path:
    """Get the scripts/pixi directory."""
    return get_pixi_project_root() / "scripts" / "pixi"


def ensure_uv_shim() -> None:
    """
    Ensure the uv shim exists in scripts/pixi/.

    The shim wraps uv to unset CONDA_PREFIX, ensuring uv targets .venv
    instead of the pixi environment.

    We copy the uv-shim entry point launcher to scripts/pixi/uv (or uv.exe on Windows).
    The launcher is generated by pip at install time with the correct paths for this machine.
    """
    scripts_dir = get_scripts_dir()
    scripts_dir.mkdir(parents=True, exist_ok=True)

    if sys.platform == "win32":
        target = scripts_dir / "uv.exe"
    else:
        target = scripts_dir / "uv"

    if not target.exists():
        # Find the uv-shim entry point executable that pip installed
        source = shutil.which("uv-shim")
        if source:
            print(f"Installing uv shim: {target}")
            shutil.copy(source, target)
            # Ensure executable on Unix
            if sys.platform != "win32":
                target.chmod(0o755)
        else:
            print("ERROR: uv-shim not found in PATH", file=sys.stderr)
            sys.exit(1)


def ensure_pyo3_build_cfg() -> None:
    """
    Ensure pyo3-build.cfg exists for cargo builds.

    Uses python from PATH to match what PYO3_PYTHON="python" resolves to.
    """
    pixi_root = get_pixi_project_root()
    config_file = pixi_root / "rerun_py" / "pyo3-build.cfg"

    if not config_file.exists():
        print(f"Generating {config_file}")
        script = pixi_root / "scripts" / "generate_pyo3_config.py"
        subprocess.run([sys.executable, str(script)], check=True)


def main() -> None:
    """Entry point for ensure-rerun-env command."""
    ensure_uv_shim()
    ensure_pyo3_build_cfg()


def uv_shim_main() -> None:
    """
    Entry point for uv-shim command.

    This is the actual uv wrapper that gets copied to scripts/pixi/uv.exe on Windows.
    It unsets CONDA_PREFIX and execs the real uv.
    """
    # Remove CONDA_PREFIX so uv targets .venv instead of pixi env
    os.environ.pop("CONDA_PREFIX", None)

    pixi_root = get_pixi_project_root()

    if sys.platform == "win32":
        real_uv = pixi_root / ".pixi" / "envs" / "default" / "Scripts" / "uv.exe"
    else:
        real_uv = pixi_root / ".pixi" / "envs" / "default" / "bin" / "uv"

    # Pass through all arguments
    args = [str(real_uv)] + sys.argv[1:]

    if sys.platform == "win32":
        # On Windows, no exec(), so subprocess and exit
        result = subprocess.run(args)
        sys.exit(result.returncode)
    else:
        # On Unix, exec replaces this process
        os.execv(str(real_uv), args)


if __name__ == "__main__":
    main()
