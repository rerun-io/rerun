name: "Setup Rust Cache"

inputs:
  save:
    type: boolean
    required: true
    default: true
  workload_identity_provider:
    type: string
    required: true
  service_account:
    type: string
    required: true

runs:
  using: "composite"
  steps:
    - name: Set up GCP credentials
      uses: google-github-actions/auth@v1
      with:
        workload_identity_provider: ${{ inputs.workload_identity_provider }}
        service_account: ${{ inputs.service_account }}

    # Rust-cache will cache our dependencies, which is a large chunk of the build
    # See: https://github.com/Swatinem/rust-cache
    - name: Set up rust-cache
      uses: Swatinem/rust-cache@v2
      with:
        save-if: true

    - name: Set up sccache
      uses: rerun-io/sccache-action@v0.6.4
      with:
        use_gcs: true
        gcs_bucket: rerun-sccache
        gcs_read_only: false

    - name: Display sccache config
      shell: bash
      run: |
        cat $HOME/.config/sccache/config

    - name: Verify sccache
      shell: bash
      run: |
        sccache --show-stats

