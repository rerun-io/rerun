# This action sets up:
# - The correct version of Rust based on the `rust-toolchain` file
# - All components + targets specified in `rust-toolchain`
# - `cargo nextest`
# - Caching

name: "Setup Rust"

inputs:
  toolchains:
    type: string
    required: false
    description: "Space-separated list of extra toolchains to install"
  targets:
    type: string
    required: false
    description: "One or more space separated target triplets that will be ensured to be supported."
  cache_key_suffix:
    type: string
    required: false
    description: "Optional suffix for cache key (e.g., matrix values)"
  save_cache:
    type: boolean
    required: false
    default: true
    description: "Whether to save the cache"

runs:
  using: "composite"
  steps:
    # Needed because the default is clang 15 and it fails to compile some dependencies for wasm, with "LLVM error:
    # section too large".
    - name: Use clang 18 (mac)
      if: ${{ runner.os == 'macOS' }}
      run: |
        echo "$(brew --prefix llvm@18)/bin" >> $GITHUB_PATH
      shell: bash --noprofile --norc -euo pipefail {0}

    - name: Check clang version
      if: ${{ runner.os == 'macOS' }}
      run: |
        clang --version
        which clang
      shell: bash --noprofile --norc -euo pipefail {0}

    - name: Ensure correct version of Rust is installed
      shell: bash --noprofile --norc -euo pipefail {0}
      run: |
        # This is the only way to force rustup to install the version of Rust
        # and the components/targets specified in our `rust-toolchain` file.
        # It might break at some point: https://github.com/rust-lang/rustup/issues/1397
        rustup show

    - name: Install additional targets
      if: ${{ inputs.targets != '' }}
      shell: bash --noprofile --norc -euo pipefail {0}
      run: rustup target add ${{ inputs.targets }}

    - name: Install additional toolchains
      if: ${{ inputs.toolchains }}
      shell: bash --noprofile --norc -euo pipefail {0}
      run: |
        for toolchain in ${{ inputs.toolchains }}; do
          rustup install $toolchain
        done

    # Recommended way to install nextest on CI.
    - name: Install latest nextest release
      uses: taiki-e/install-action@v2.48.7
      with:
        tool: nextest@0.9.89

    - name: Compute branch for cache key
      id: branch
      shell: bash --noprofile --norc -euo pipefail {0}
      run: |
        BRANCH="${GITHUB_HEAD_REF:-$GITHUB_REF_NAME}"
        echo "name=$(echo "$BRANCH" | tr '/' '-' | tr ':' '-')" >> $GITHUB_OUTPUT

    - name: Setup Rust cache
      uses: Swatinem/rust-cache@v2
      with:
        prefix-key: "v1-rust"
        shared-key: "${{ steps.branch.outputs.name }}-${{ github.job }}${{ inputs.cache_key_suffix && format('-{0}', inputs.cache_key_suffix) || '' }}"
        add-job-id-key: "false"
        cache-all-crates: "true"
        cache-workspace-crates: "true"
        cache-targets: "true"
        cache-on-failure: "true"
        save-if: ${{ inputs.save_cache }}
