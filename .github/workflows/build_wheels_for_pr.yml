name: Build and Upload Wheels for PR

on:
  workflow_dispatch:

jobs:

  check_for_pr:
    runs-on: ubuntu-latest
    outputs:
      PR_NUMBER: ${{ steps.get_pr.outputs.PR_NUMBER }}
    steps:
      - name: Check if commit belongs to a PR
        id: get_pr
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          pr_number=$(curl --silent --header "Authorization: Bearer ${GITHUB_TOKEN}" \
            --url "https://api.github.com/repos/${GITHUB_REPOSITORY}/commits/${GITHUB_SHA}/pulls" \
            | jq '.[] | .number')

          if [ -z "$pr_number" ]; then
            echo "No PR associated with this commit"
            exit 1
          else
            echo "Commit is associated with PR: $pr_number"
            echo "PR_NUMBER=$pr_number" >> "$GITHUB_OUTPUT"
          fi

  build_linux:
    needs: [check_for_pr]
    name: 'Linux: Build/Test Wheels'
    uses: ./.github/workflows/reusable_build_and_test_wheels.yml
    with:
      PLATFORM: linux
      WHEEL_ARTIFACT_NAME: linux-wheel
      RRD_ARTIFACT_NAME: linux-rrd
    secrets: inherit

  build_windows:
    needs: [check_for_pr]
    name: 'Windows: Build/Test Wheels'
    uses: ./.github/workflows/reusable_build_and_test_wheels.yml
    with:
      PLATFORM: windows
      WHEEL_ARTIFACT_NAME: windows-wheel
      RRD_ARTIFACT_NAME: ''
    secrets: inherit

  build_macos_arm:
    needs: [check_for_pr]
    name: 'Macos-Arm: Build/Test Wheels'
    uses: ./.github/workflows/reusable_build_and_test_wheels.yml
    with:
      PLATFORM: macos-arm
      WHEEL_ARTIFACT_NAME: macos-arm-wheel
      RRD_ARTIFACT_NAME: ''
    secrets: inherit

  build_macos_intel:
    needs: [check_for_pr]
    name: 'Macos-Intel: Build/Test Wheels'
    uses: ./.github/workflows/reusable_build_and_test_wheels.yml
    with:
      PLATFORM: macos-intel
      WHEEL_ARTIFACT_NAME: 'macos-intel-wheel'
      RRD_ARTIFACT_NAME: ''
    secrets: inherit

  upload_wheels_linux:
    name: 'Linux: Upload Wheels'
    needs: [build_linux]
    uses: ./.github/workflows/reusable_upload_wheels.yml
    with:
      EXPECTED_VERSION: ${{ needs.build_linux.outputs.EXPECTED_VERSION }}
      WHEEL_ARTIFACT_NAME: linux-wheel
      RRD_ARTIFACT_NAME: linux-rrd
    secrets: inherit

  upload_wheels_windows:
    name: 'Windows: Upload Wheels'
    needs: [build_linux, build_windows]
    uses: ./.github/workflows/reusable_upload_wheels.yml
    with:
      EXPECTED_VERSION: ${{ needs.build_windows.outputs.EXPECTED_VERSION }}
      WHEEL_ARTIFACT_NAME: windows-wheel
      RRD_ARTIFACT_NAME: linux-rrd
    secrets: inherit

  upload_wheels_macos_arm:
    name: 'Macos-Arm: Upload Wheels'
    needs: [build_linux, build_macos_arm]
    uses: ./.github/workflows/reusable_upload_wheels.yml
    with:
      EXPECTED_VERSION: ${{ needs.build_macos_arm.outputs.EXPECTED_VERSION }}
      WHEEL_ARTIFACT_NAME: macos-arm-wheel
      RRD_ARTIFACT_NAME: linux-rrd
    secrets: inherit

  upload_wheels_macos_intel:
    name: 'Macos-Intel: Upload Wheels'
    needs: [build_linux, build_macos_intel]
    uses: ./.github/workflows/reusable_upload_wheels.yml
    with:
      EXPECTED_VERSION: ${{ needs.build_macos_intel.outputs.EXPECTED_VERSION }}
      WHEEL_ARTIFACT_NAME: macos-intel-wheel
      RRD_ARTIFACT_NAME: linux-rrd
    secrets: inherit


  save_pr_summary:
    name: 'Save PR Summary'
    needs: [check_for_pr, upload_wheels_linux, upload_wheels_windows, upload_wheels_macos_arm, upload_wheels_macos_intel]
    uses: ./.github/workflows/reusable_pr_summary.yml
    with:
      PR_NUMBER: ${{ needs.check_for_pr.outputs.PR_NUMBER}}
    secrets: inherit
