name: "Auto Approve Workflow Runs"

on: pull_request_target

permissions:
  actions: "write"

jobs:
  auto-approve-workflow:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.ref }}

      - name: Approve workflow run
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Give GitHub a bit of time to synchronize everything
          sleep 10s

          set +e
          comments=$(gh pr view --json comments)
          set -e

          # The enum values are explained here:
          # https://docs.github.com/en/graphql/reference/enums#commentauthorassociation
          expr='
          .comments
            | map(select(.authorAssociation | IN("COLLABORATOR", "MEMBER", "OWNER")))
            | any(.body | contains("@rerun-bot approve"))
          '

          if [ $(echo "$comments" | jq "$expr") = "true" ]; then
            echo "approving workflow run ${{ github.run_id }}"
            # https://docs.github.com/en/rest/actions/workflow-runs?apiVersion=2022-11-28#approve-a-workflow-run-for-a-fork-pull-request
            curl -L \
              -X POST \
              -H "Accept: application/vnd.github+json" \
              -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              https://api.github.com/repos/rerun-io/rerun/actions/runs/${{ github.run_id }}/approve
          fi

