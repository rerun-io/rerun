name: "Auto Approve Workflow Runs"

on: pull_request

permissions:
  actions: "write"

jobs:
  auto-approve-workflow:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.ref }}

      - name: Approve workflow run
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set +e

          comments=$(gh pr view --json comments)

          # The enum values are explained here:
          # https://docs.github.com/en/graphql/reference/enums#commentauthorassociation
          expr='
          .comments
            | map(select(.authorAssociation | IN("COLLABORATOR", "MEMBER", "OWNER")))
            | any(.body | contains("@rerun-bot approve"))
          '

          if [ $(echo "$comments" | jq "$expr") = "true" ]; then
            echo "can approve run_id:${{ github.run_id }}"
          fi

