name: Manually Dispatch Workflows

on:
  workflow_dispatch:
    # NOTE: boolean inputs are still actually strings
    # See: https://github.com/actions/runner/issues/1483
    inputs:
      BENCHES:
        description: 'Run Benches'
        type: boolean
        required: false
        default: false
      BUILD_WEB:
        description: 'Build Web'
        type: boolean
        required: false
        default: false
      CHECKS:
        description: 'Run All Checks'
        type: boolean
        required: false
        default: true
      DEPLOY_DOCS:
        description: 'Deploy the docs to refs.rerun.io'
        type: boolean
        required: false
        default: false
      MIN_TEST_WHEEL:
        description: 'Test Minimum Wheel'
        type: boolean
        required: false
      RELEASE_VERSION:
        description: 'Release'
        type: string
        required: false
        default: 'prerelease'
      SAVE_CACHE:
        description: 'Save Cache'
        type: boolean
        required: false
        default: false
      SAVE_PR:
        description: 'Save PR Summary'
        type: string
        required: false
        default: ''
      UPLOAD_GCLOUD:
        description: 'Upload to gcloud'
        type: boolean
        required: false
        default: false
      WHEEL_PLATFORMS:
        description: 'Platforms to build wheels for'
        type: string
        required: false
        default: ''

jobs:
  checks:
    name: Run All Checks
    if: ${{ github.event.inputs.CHECKS == 'true' }}
    uses: ./.github/workflows/reusable_checks.yml
    with:
      SAVE_CACHE: ${{ github.event.inputs.SAVE_CACHE == 'true' }}
    secrets: inherit

  deploy_docs:
    # Never deploy docs if checks haven't passed
    needs: [checks]
    name: Deploy Docs
    if: ${{ github.event.inputs.DEPLOY_DOCS == 'true' }}
    uses: ./.github/workflows/reusable_deploy_docs.yml
    with:
      PY_DOCS_VERSION_NAME: "test"
      UPDATE_LATEST: false
    secrets: inherit

  min_test_wheel:
    name: 'Minimum Test Wheel'
    # The upload-web job uses the min-test-wheel to get the RRD
    if: ${{ (github.event.inputs.MIN_TEST_WHEEL == 'true') || ((github.event.inputs.UPLOAD_GCLOUD == 'true') && ( github.event.inputs.BUILD_WEB == 'true') ) }}
    uses: ./.github/workflows/reusable_build_and_test_wheels.yml
    with:
      SAVE_CACHE: ${{ github.event.inputs.SAVE_CACHE == 'true' }}
      PLATFORM: linux
      MATURIN_FEATURE_FLAGS: '--no-default-features --features extension-module'
      WHEEL_ARTIFACT_NAME: ''
      RRD_ARTIFACT_NAME: linux-rrd-fast
    secrets: inherit

  benches:
    name: Benchmarks
    if: ${{ github.event.inputs.BENCHES == 'true' }}
    uses: ./.github/workflows/reusable_bench.yml
    secrets: inherit

  build_linux:
    name: 'Linux: Build/Test Wheels'

    # If we are uploading any build target, we also need the linux job to run since it produces the RRD
    # TODO(jleibs): Debug why multi-line if statements don't work here
    if: ${{ contains(github.event.inputs.WHEEL_PLATFORMS, 'linux') || ((github.event.inputs.UPLOAD_GCLOUD == 'true') && ( github.event.inputs.WHEEL_PLATFORMS != '') ) }}

    uses: ./.github/workflows/reusable_build_and_test_wheels.yml
    with:
      SAVE_CACHE: ${{ github.event.inputs.SAVE_CACHE == 'true' }}
      PLATFORM: linux
      WHEEL_ARTIFACT_NAME: linux-wheel
      RRD_ARTIFACT_NAME: linux-rrd
      RELEASE_VERSION: ${{ github.event.inputs.RELEASE_VERSION }}
    secrets: inherit

  build_windows:
    name: 'Windows: Build/Test Wheels'
    if: ${{ contains(github.event.inputs.WHEEL_PLATFORMS, 'windows') }}
    uses: ./.github/workflows/reusable_build_and_test_wheels.yml
    with:
      SAVE_CACHE: ${{ github.event.inputs.SAVE_CACHE == 'true' }}
      PLATFORM: windows
      WHEEL_ARTIFACT_NAME: windows-wheel
      RRD_ARTIFACT_NAME: ''
      RELEASE_VERSION: ${{ github.event.inputs.RELEASE_VERSION }}
    secrets: inherit

  build_macos_arm:
    name: 'Macos-Arm: Build/Test Wheels'
    if: ${{ contains(github.event.inputs.WHEEL_PLATFORMS, 'macos-arm') }}
    uses: ./.github/workflows/reusable_build_and_test_wheels.yml
    with:
      SAVE_CACHE: ${{ github.event.inputs.SAVE_CACHE == 'true' }}
      PLATFORM: macos-arm
      WHEEL_ARTIFACT_NAME: macos-arm-wheel
      RRD_ARTIFACT_NAME: ''
      RELEASE_VERSION: ${{ github.event.inputs.RELEASE_VERSION }}
    secrets: inherit

  build_macos_intel:
    name: 'Macos-Intel: Build/Test Wheels'
    if: ${{ contains(github.event.inputs.WHEEL_PLATFORMS, 'macos-intel') }}
    uses: ./.github/workflows/reusable_build_and_test_wheels.yml
    with:
      SAVE_CACHE: ${{ github.event.inputs.SAVE_CACHE == 'true' }}
      PLATFORM: macos-intel
      WHEEL_ARTIFACT_NAME: 'macos-intel-wheel'
      RRD_ARTIFACT_NAME: ''
      RELEASE_VERSION: ${{ github.event.inputs.RELEASE_VERSION }}

    secrets: inherit

  upload_wheels_linux:
    name: 'Linux: Upload Wheels'
    needs: [build_linux]
    if: ${{ contains(github.event.inputs.WHEEL_PLATFORMS, 'linux') && (github.event.inputs.UPLOAD_GCLOUD == 'true') }}
    uses: ./.github/workflows/reusable_upload_wheels.yml
    with:
      EXPECTED_VERSION: ${{ needs.build_linux.outputs.EXPECTED_VERSION }}
      WHEEL_ARTIFACT_NAME: linux-wheel
      RRD_ARTIFACT_NAME: linux-rrd
    secrets: inherit

  upload_wheels_windows:
    name: 'Windows: Upload Wheels'
    needs: [build_linux, build_windows]
    if: ${{ contains(github.event.inputs.WHEEL_PLATFORMS, 'windows') && (github.event.inputs.UPLOAD_GCLOUD == 'true') }}
    uses: ./.github/workflows/reusable_upload_wheels.yml
    with:
      EXPECTED_VERSION: ${{ needs.build_windows.outputs.EXPECTED_VERSION }}
      WHEEL_ARTIFACT_NAME: windows-wheel
      RRD_ARTIFACT_NAME: linux-rrd
    secrets: inherit

  upload_wheels_macos_arm:
    name: 'Macos-Arm: Upload Wheels'
    needs: [build_linux, build_macos_arm]
    if: ${{ contains(github.event.inputs.WHEEL_PLATFORMS, 'macos-arm') && (github.event.inputs.UPLOAD_GCLOUD == 'true') }}
    uses: ./.github/workflows/reusable_upload_wheels.yml
    with:
      EXPECTED_VERSION: ${{ needs.build_macos_arm.outputs.EXPECTED_VERSION }}
      WHEEL_ARTIFACT_NAME: macos-arm-wheel
      RRD_ARTIFACT_NAME: linux-rrd
    secrets: inherit

  upload_wheels_macos_intel:
    name: 'Macos-Intel: Upload Wheels'
    needs: [build_linux, build_macos_intel]
    if: ${{ contains(github.event.inputs.WHEEL_PLATFORMS, 'macos-intel') && (github.event.inputs.UPLOAD_GCLOUD == 'true') }}
    uses: ./.github/workflows/reusable_upload_wheels.yml
    with:
      EXPECTED_VERSION: ${{ needs.build_macos_intel.outputs.EXPECTED_VERSION }}
      WHEEL_ARTIFACT_NAME: macos-intel-wheel
      RRD_ARTIFACT_NAME: linux-rrd
    secrets: inherit

  build_web:
    name: 'Build Web'
    if: ${{ github.event.inputs.BUILD_WEB == 'true'}}
    uses: ./.github/workflows/reusable_build_web.yml
    with:
      RELEASE_VERSION: ${{ github.event.inputs.RELEASE_VERSION }}
    secrets: inherit

  upload_web:
    name: 'Upload Web'
    # Uses Assets:
    #   build_linux: rrd
    #   build_web: web_viewer
    needs: [min_test_wheel, build_web]
    if: ${{ (github.event.inputs.BUILD_WEB == 'true') && (github.event.inputs.UPLOAD_GCLOUD == 'true') }}
    uses: ./.github/workflows/reusable_upload_web.yml
    with:
      MARK_PRERELEASE_FOR_MAINLINE: false
      MARK_TAGGED_VERSION: false
      RRD_ARTIFACT_NAME: linux-rrd-fast
    secrets: inherit

  save_pr_summary:
    name: 'Save PR Summary'
    needs: [upload_web, upload_wheels_linux]
    if: ${{ github.event.inputs.SAVE_PR != '' }}
    uses: ./.github/workflows/reusable_pr_summary.yml
    with:
      PR_NUMBER: ${{ github.event.inputs.SAVE_PR }}
    secrets: inherit
