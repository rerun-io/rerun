name: Manually Dispatch Workflows

on:
  workflow_dispatch:
    # NOTE: boolean inputs are still actually strings
    # See: https://github.com/actions/runner/issues/1483
    inputs:
      CHECKS:
        description: 'Run All Checks'
        type: boolean
        required: false
        default: true
      BENCHES:
        description: 'Run Benches'
        type: boolean
        required: false
        default: false
      BUILD_LINUX:
        description: 'Build/Test Wheels Linux'
        type: boolean
        required: false
        default: true
      BUILD_MACOS_INTEL:
        description: 'Build/Test Wheels Mac (Intel)'
        type: boolean
        required: false
        default: false
      BUILD_MACOS_ARM:
        description: 'Build/Test Wheels Mac (Arm)'
        type: boolean
        required: false
        default: false
      BUILD_WINDOWS:
        description: 'Build/Test Wheels Win'
        type: boolean
        required: false
        default: false
      BUILD_WEB:
        description: 'Build Web'
        type: boolean
        required: false
        default: false
      UPLOAD_GCLOUD:
        description: 'Upload to gcloud'
        type: boolean
        required: false
        default: false
      RELEASE:
        description: 'Release'
        type: string
        required: false
        default: ''
      SAVE_CACHE:
        description: 'Save Cache'
        type: boolean
        required: false
        default: false

jobs:
  checks:
    name: Run All Checks
    if: ${{ github.event.inputs.CHECKS == 'true' }}
    uses: ./.github/workflows/reusable_checks.yml
    with:
      SAVE_CACHE: ${{ github.event.inputs.SAVE_CACHE == 'true' }}
      SAVE_DOCS_AS: ${{ github.event.inputs.SAVE_DOCS_AS }}
    secrets: inherit

  benches:
    name: Benchmarks
    if: ${{ github.event.inputs.BENCHES == 'true' }}
    uses: ./.github/workflows/reusable_bench.yml
    secrets: inherit

  build_linux:
    name: 'Linux: Build/Test Wheels'

    # If we are uploading any build target, we also need the linux job to run since it produces the RRD
    # TODO(jleibs): Debug why multi-line if statements don't work here
    if: ${{ (github.event.inputs.BUILD_LINUX == 'true') || ((github.event.inputs.UPLOAD_GCLOUD == 'true') && ( (github.event.inputs.BUILD_MACOS_INTEL == 'true') || (github.event.inputs.BUILD_MACOS_ARM == 'true') || (github.event.inputs.BUILD_WINDOWS == 'true') || (github.event.inputs.BUILD_WEB == 'true'))) }}

    uses: ./.github/workflows/reusable_build_and_test_wheels.yml
    with:
      SAVE_CACHE: ${{ github.event.inputs.SAVE_CACHE == 'true' }}
      PLATFORM: linux
    secrets: inherit

  build_windows:
    name: 'Windows: Build/Test Wheels'
    if: ${{ github.event.inputs.BUILD_WINDOWS == 'true'}}
    uses: ./.github/workflows/reusable_build_and_test_wheels.yml
    with:
      SAVE_CACHE: ${{ github.event.inputs.SAVE_CACHE == 'true' }}
      PLATFORM: windows
    secrets: inherit

  build_macos_arm:
    name: 'Macos-Arm: Build/Test Wheels'
    if: ${{ github.event.inputs.BUILD_MACOS_ARM == 'true' }}
    uses: ./.github/workflows/reusable_build_and_test_wheels.yml
    with:
      SAVE_CACHE: ${{ github.event.inputs.SAVE_CACHE == 'true' }}
      PLATFORM: macos-arm
    secrets: inherit

  build_macos_intel:
    name: 'Macos-Intel: Build/Test Wheels'
    if: ${{ github.event.inputs.BUILD_MACOS_INTEL == 'true' }}
    uses: ./.github/workflows/reusable_build_and_test_wheels.yml
    with:
      SAVE_CACHE: ${{ github.event.inputs.SAVE_CACHE == 'true' }}
      PLATFORM: macos-intel
    secrets: inherit

  upload_wheels_linux:
    name: 'Linux: Upload Wheels'
    needs: [build_linux]
    if: ${{ (github.event.inputs.BUILD_LINUX) == 'true' && (github.event.inputs.UPLOAD_GCLOUD == 'true') }}
    uses: ./.github/workflows/reusable_upload_wheels.yml
    with:
      PLATFORM: linux
      EXPECTED_VERSION: ${{ needs.build_linux.outputs.EXPECTED_VERSION }}
    secrets: inherit

  upload_wheels_windows:
    name: 'Windows: Upload Wheels'
    needs: [build_linux, build_windows]
    if: ${{ (github.event.inputs.BUILD_WINDOWS) == 'true' && (github.event.inputs.UPLOAD_GCLOUD == 'true') }}
    uses: ./.github/workflows/reusable_upload_wheels.yml
    with:
      PLATFORM: windows
      EXPECTED_VERSION: ${{ needs.build_windows.outputs.EXPECTED_VERSION }}
    secrets: inherit

  upload_wheels_macos_arm:
    name: 'Macos-Arm: Upload Wheels'
    needs: [build_linux, build_macos_arm]
    if: ${{ (github.event.inputs.BUILD_MACOS_ARM) == 'true' && (github.event.inputs.UPLOAD_GCLOUD == 'true') }}
    uses: ./.github/workflows/reusable_upload_wheels.yml
    with:
      PLATFORM: macos-arm
      EXPECTED_VERSION: ${{ needs.build_macos_arm.outputs.EXPECTED_VERSION }}
    secrets: inherit

  upload_wheels_macos_intel:
    name: 'Macos-Intel: Upload Wheels'
    needs: [build_linux, build_macos_intel]
    if: ${{ (github.event.inputs.BUILD_MACOS_INTEL) == 'true' && (github.event.inputs.UPLOAD_GCLOUD == 'true') }}
    uses: ./.github/workflows/reusable_upload_wheels.yml
    with:
      PLATFORM: macos-intel
      EXPECTED_VERSION: ${{ needs.build_macos_intel.outputs.EXPECTED_VERSION }}
    secrets: inherit

  build_web:
    name: 'Build Web'
    if: ${{ github.event.inputs.BUILD_WEB == 'true'}}
    uses: ./.github/workflows/reusable_build_web.yml
    with:
      RELEASE: ${{ github.event.inputs.RELEASE }}
    secrets: inherit

  upload_web:
    name: 'Upload Web'
    # Uses Assets:
    #   build_linux: rrd
    #   build_web: web_viewer
    needs: [build_linux, build_web]
    if: ${{ (github.event.inputs.BUILD_WEB == 'true') && (github.event.inputs.UPLOAD_GCLOUD == 'true') }}
    uses: ./.github/workflows/reusable_upload_web.yml
    with:
      RELEASE: ${{ github.event.inputs.RELEASE }}
    secrets: inherit
