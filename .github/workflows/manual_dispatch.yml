name: Manually Dispatch Workflows

on:
  workflow_dispatch:
    # NOTE: boolean inputs are still actually strings
    # See: https://github.com/actions/runner/issues/1483
    inputs:
      LINTS:
        description: 'Run Lints'
        type: boolean
        required: false
        default: true
      BUILD_LINUX:
        description: 'Build/Test Linux'
        type: boolean
        required: false
        default: true
      BUILD_MACOS_INTEL:
        description: 'Build/Test Mac (Intel)'
        type: boolean
        required: false
        default: false
      BUILD_MACOS_ARM:
        description: 'Build/Test Mac (Arm)'
        type: boolean
        required: false
        default: false
      BUILD_WINDOWS:
        description: 'Build/Test Win'
        type: boolean
        required: false
        default: false
      PACKAGE:
        description: 'Package'
        type: boolean
        required: false
        default: false
      RELEASE:
        description: 'Release'
        type: boolean
        required: false
        default: false
      SAVE_CACHE:
        description: 'Save Cache'
        type: boolean
        required: false
        default: false

jobs:
  lint_all:
    name: Lint All
    if: ${{ github.event.inputs.LINTS == 'true' }}
    uses: ./.github/workflows/reusable_lint.yml
    with:
      SAVE_CACHE: ${{ github.event.inputs.SAVE_CACHE == 'true' }}
    secrets:
      CALLER_GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build_linux:
    name: 'Linux: Build/Test'

    # If we are packaging any build target, we also need the linux job to run since it produces the RRD
    if: |
      ${{ (github.event.inputs.BUILD_LINUX == 'true') ||
            ((github.event.inputs.PACKAGE == 'true') && (
              (github.event.inputs.BUILD_MACOS_INTEL == 'true') ||
              (github.event.inputs.BUILD_MACOS_ARM == 'true') ||
              (github.event.inputs.BUILD_WINDOWS == 'true'))) }}

    uses: ./.github/workflows/reusable_build_and_test.yml
    with:
      SAVE_CACHE: ${{ github.event.inputs.SAVE_CACHE == 'true' }}
      PLATFORM: linux
    secrets:
      CALLER_GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build_windows:
    name: 'Windows: Build/Test'
    if: ${{ github.event.inputs.BUILD_WINDOWS == 'true'}}
    uses: ./.github/workflows/reusable_build_and_test.yml
    with:
      SAVE_CACHE: ${{ github.event.inputs.SAVE_CACHE == 'true' }}
      PLATFORM: windows
    secrets:
      CALLER_GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build_macos_arm:
    name: 'Macos-Arm: Build/Test'
    if: ${{ github.event.inputs.BUILD_MACOS_ARM == 'true' }}
    uses: ./.github/workflows/reusable_build_and_test.yml
    with:
      SAVE_CACHE: ${{ github.event.inputs.SAVE_CACHE == 'true' }}
      PLATFORM: macos-arm
    secrets:
      CALLER_GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build_macos_intel:
    name: 'Macos-Intel: Build/Test'
    if: ${{ github.event.inputs.BUILD_MACOS_INTEL == 'true' }}
    uses: ./.github/workflows/reusable_build_and_test.yml
    with:
      SAVE_CACHE: ${{ github.event.inputs.SAVE_CACHE == 'true' }}
      PLATFORM: macos-intel
    secrets:
      CALLER_GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  package_and_upload_linux:
    name: 'Linux: Package and Upload'
    needs: [build_linux]
    if: ${{ (github.event.inputs.BUILD_LINUX) == 'true' && (github.event.inputs.PACKAGE == 'true') }}
    uses: ./.github/workflows/reusable_package_and_upload.yml
    with:
      PLATFORM: linux
      EXPECTED_VERSION: ${{ needs.build_linux.outputs.EXPECTED_VERSION }}
    secrets:
      CALLER_GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  package_and_upload_windows:
    name: 'Windows: Package and Upload'
    needs: [build_linux, build_windows]
    if: ${{ (github.event.inputs.BUILD_WINDOWS) == 'true' && (github.event.inputs.PACKAGE == 'true') }}
    uses: ./.github/workflows/reusable_package_and_upload.yml
    with:
      PLATFORM: windows
      EXPECTED_VERSION: ${{ needs.build_windows.outputs.EXPECTED_VERSION }}
    secrets:
      CALLER_GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  package_and_upload_macos_arm:
    name: 'Macos-Arm: Package and Upload'
    needs: [build_linux, build_macos_arm]
    if: ${{ (github.event.inputs.BUILD_MACOS_ARM) == 'true' && (github.event.inputs.PACKAGE == 'true') }}
    uses: ./.github/workflows/reusable_package_and_upload.yml
    with:
      PLATFORM: macos-arm
      EXPECTED_VERSION: ${{ needs.build_macos_arm.outputs.EXPECTED_VERSION }}
    secrets:
      CALLER_GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  package_and_upload_macos_intel:
    name: 'Macos-Intel: Package and Upload'
    needs: [build_linux, build_macos_intel]
    if: ${{ (github.event.inputs.BUILD_MACOS_INTEL) == 'true' && (github.event.inputs.PACKAGE == 'true') }}
    uses: ./.github/workflows/reusable_package_and_upload.yml
    with:
      PLATFORM: macos-intel
      EXPECTED_VERSION: ${{ needs.build_macos_intel.outputs.EXPECTED_VERSION }}
    secrets:
      CALLER_GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
