name: Build and publish wheels

on:
  workflow_call:
    inputs:
      CONCURRENCY:
        type: string
        required: true
      RELEASE_VERSION:
        description: "Release Version Number (Must match Cargo.toml)"
        type: string
        required: true

jobs:
  ### Linux
  build-linux:
    name: "Linux: Build/Test Wheels"
    uses: ./.github/workflows/reusable_build_and_test_wheels.yml
    with:
      CONCURRENCY: ${{ inputs.CONCURRENCY }}
      PLATFORM: linux
      WHEEL_ARTIFACT_NAME: linux-wheel
      RRD_ARTIFACT_NAME: linux-rrd
      RELEASE_VERSION: ${{ inputs.RELEASE_VERSION }}
    secrets: inherit

  upload-wheels-linux:
    name: "Linux: Upload Wheels"
    needs: [build-linux]
    uses: ./.github/workflows/reusable_upload_wheels.yml
    with:
      CONCURRENCY: ${{ inputs.CONCURRENCY }}
      WHEEL_ARTIFACT_NAME: linux-wheel
      RRD_ARTIFACT_NAME: linux-rrd
    secrets: inherit

  ### Windows
  build-windows:
    name: "Windows: Build/Test Wheels"
    uses: ./.github/workflows/reusable_build_and_test_wheels.yml
    with:
      CONCURRENCY: ${{ inputs.CONCURRENCY }}
      PLATFORM: windows
      WHEEL_ARTIFACT_NAME: windows-wheel
      RRD_ARTIFACT_NAME: ""
      RELEASE_VERSION: ${{ inputs.RELEASE_VERSION }}
    secrets: inherit

  upload-wheels-windows:
    name: "Windows: Upload Wheels"
    needs: [build-linux, build-windows]
    uses: ./.github/workflows/reusable_upload_wheels.yml
    with:
      CONCURRENCY: ${{ inputs.CONCURRENCY }}
      WHEEL_ARTIFACT_NAME: windows-wheel
      RRD_ARTIFACT_NAME: linux-rrd
    secrets: inherit

  ### macOS (arm)
  build-macos-arm:
    name: "Macos-Arm: Build/Test Wheels"
    uses: ./.github/workflows/reusable_build_and_test_wheels.yml
    with:
      CONCURRENCY: ${{ inputs.CONCURRENCY }}
      PLATFORM: macos-arm
      WHEEL_ARTIFACT_NAME: macos-arm-wheel
      RRD_ARTIFACT_NAME: ""
      RELEASE_VERSION: ${{ inputs.RELEASE_VERSION }}
    secrets: inherit

  upload-wheels-macos-arm:
    name: "Macos-Arm: Upload Wheels"
    needs: [build-linux, build-macos-arm]
    uses: ./.github/workflows/reusable_upload_wheels.yml
    with:
      CONCURRENCY: ${{ inputs.CONCURRENCY }}
      WHEEL_ARTIFACT_NAME: macos-arm-wheel
      RRD_ARTIFACT_NAME: linux-rrd
    secrets: inherit

  ### macOS (intel)
  build-macos-intel:
    name: "Macos-Intel: Build/Test Wheels"
    uses: ./.github/workflows/reusable_build_and_test_wheels.yml
    with:
      CONCURRENCY: ${{ inputs.CONCURRENCY }}
      PLATFORM: macos-intel
      WHEEL_ARTIFACT_NAME: "macos-intel-wheel"
      RRD_ARTIFACT_NAME: ""
      RELEASE_VERSION: ${{ inputs.RELEASE_VERSION }}
    secrets: inherit

  upload-wheels-macos-intel:
    name: "Macos-Intel: Upload Wheels"
    needs: [build-linux, build-macos-intel]
    uses: ./.github/workflows/reusable_upload_wheels.yml
    with:
      CONCURRENCY: ${{ inputs.CONCURRENCY }}
      WHEEL_ARTIFACT_NAME: macos-intel-wheel
      RRD_ARTIFACT_NAME: linux-rrd
    secrets: inherit

  generate-wheel-index:
    name: "Generate Pip Index"
    needs:
      [
        upload-wheels-linux,
        upload-wheels-windows,
        upload-wheels-macos-arm,
        upload-wheels-macos-intel,
      ]
    uses: ./.github/workflows/reusable_pip_index.yml
    with:
      CONCURRENCY: ${{ inputs.CONCURRENCY }}
    secrets: inherit

