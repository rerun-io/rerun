name: Reusable Bench

on:
  workflow_call:
    inputs:
      SAVE_BENCHES:
        required: false
        type: boolean
        default: false
      BENCH_NAME:
        required: false
        type: string
        default: ''
      COMPARE_TO:
        required: false
        type: string
        default: ''

env:
  PYTHON_VERSION: "3.8"
  # web_sys_unstable_apis is required to enable the web_sys clipboard API which egui_web uses
  # https://rustwasm.github.io/wasm-bindgen/api/web_sys/struct.Clipboard.html
  # https://rustwasm.github.io/docs/wasm-bindgen/web-sys/unstable-apis.html
  RUSTFLAGS: --cfg=web_sys_unstable_apis --deny warnings

  # See https://github.com/ericseppanen/cargo-cranky/issues/8
  RUSTDOCFLAGS: --deny warnings --deny rustdoc::missing_crate_level_docs

  # See: https://github.com/marketplace/actions/sccache-action
  SCCACHE_GHA_ENABLED: "true"
  RUSTC_WRAPPER: "sccache"

jobs:

# ---------------------------------------------------------------------------

  rs-benchmarks:
    name: Rust Criterion benchmarks

    permissions:
      contents: "read"
      id-token: "write"

    runs-on: ubuntu-latest-16-cores

    container:
      image: rerunio/ci_docker:0.6

    steps:
      - uses: actions/checkout@v3

      - name: Set up cargo cache
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: "build-linux"
          env-vars: CARGO CC CFLAGS CXX CMAKE RUST CACHE_KEY
          # Don't update the cache -- it will be updated by the lint job
          # TODO(jleibs): this job will likely run before rust.yml updates
          # the cache. Better cross-job sequencing would be nice here
          save-if: false

      # Sccache will cache everything else
      # See: https://github.com/marketplace/actions/sccache-action
      - name: Run sccache-cache
        uses: mozilla-actions/sccache-action@v0.0.3

      - name: Add BENCH_NAME env property with commit short sha
        run: |
          if [ -z "${{ inputs.BENCH_NAME }}" ]; then
            BENCH_NAME=${{ inputs.BENCH_NAME }}
          else
            BENCH_NAME=$(echo "${{ github.sha }}"" | cut -c1-7)"
          fi
          echo "BENCH_NAME=$(echo $BENCH_NAME)" >> $GITHUB_ENV


      - name: Run benchmark
        # Use bash shell so we get pipefail behavior with tee
        shell: bash
        run: |
          cargo bench \
            --all-features \
            -p re_arrow_store \
            -p re_data_store \
            -p re_log_encoding \
            -p re_query \
            -p re_tuid \
            -- --output-format=bencher | tee ${{ runner.temp }}/${{ env.BENCH_NAME }}

      - name: Store benchmark result
        # https://github.com/benchmark-action/github-action-benchmark
        uses: benchmark-action/github-action-benchmark@v1
        with:
          name: Rust Benchmark
          tool: "cargo"
          output-file-path: ${{ runner.temp }}/${{ env.BENCH_NAME }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

          # Show alert with commit comment on detecting possible performance regression
          comment-on-alert: true
          alert-threshold: "125%"
          fail-on-alert: true
          comment-always: false # Generates too much GitHub notification spam

          # Save, results and push to GitHub only on main
          save-data-file: ${{ inputs.SAVE_BENCHES }}
          auto-push: ${{ inputs.SAVE_BENCHES }}
          gh-pages-branch: gh-pages
          benchmark-data-dir-path: dev/bench
          max-items-in-chart: 30

      - id: "auth"
        uses: google-github-actions/auth@v1
        with:
          workload_identity_provider: ${{ secrets.GOOGLE_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GOOGLE_SERVICE_ACCOUNT }}

      - name: 'Set up Cloud SDK'
        uses: 'google-github-actions/setup-gcloud@v1'
        with:
          version: '>= 363.0.0'

      - name: "Upload bench to GCS"
        uses: google-github-actions/upload-cloud-storage@v1
        with:
          path: ${{ runner.temp }}/${{ env.BENCH_NAME }}
          destination: "rerun-builds/benches/"

      - name: Download file from GCS
        if: ${{ inputs.COMPARE_TO != '' }}
        run: |
          gsutil cp gs://rerun-builds/benches/${{inputs.COMPARE_TO}} ${{ runner.temp }}/${{ inputs.COMPARE_TO }}

      - name: Install benchcmp
        if: ${{ inputs.COMPARE_TO != '' }}
        run: cargo install cargo-benchcmp

      - name: Install benchcmp
        if: ${{ inputs.COMPARE_TO != '' }}
        run: cargo run ${{ runner.temp }}/${{ inputs.COMPARE_TO }} ${{ runner.temp }}/${{ env.BENCH_NAME }} > ${{ runner.temp }}/bench_results.txt

      - name: Add SHORT_SHA env property with commit short sha
        run: echo "SHORT_SHA=`echo ${{github.sha}} | cut -c1-7`" >> $GITHUB_ENV

      - name: "Upload bench-results to GCS"
        uses: google-github-actions/upload-cloud-storage@v1
        with:
          path: ${{ runner.temp }}/bench_results.txt
          destination: "rerun-builds/commit/${{env.SHORT_SHA}}/bench_results.txt"
