#!/usr/bin/env python3
"""
Generates the permutations of view coordinate name definitions.

This will modify the different archetype extensions to include the appropriate constants.
"""
from __future__ import annotations

import argparse
import itertools
import os
from dataclasses import dataclass
from typing import Iterable

BEGIN_MARKER = "<BEGIN_GENERATED:{}>"
END_MARKER = "<END_GENERATED:{}>"

RUST_EXTENSION_FILE = "crates/re_types/src/archetypes/view_coordinates_ext.rs"
PYTHON_EXTENSION_FILE = "rerun_py/rerun_sdk/rerun/archetypes/view_coordinates_ext.py"
CPP_EXTENSION_FILE = "rerun_cpp/src/rerun/archetypes/view_coordinates_ext.cpp"

SCRIPT_PATH = os.path.relpath(__file__, os.getcwd())

################################################################################


@dataclass
class ViewCoordinates:
    name: str
    axis0: str
    axis1: str
    axis2: str


def generate_view_permutations() -> Iterable[ViewCoordinates]:
    D1 = ["Up", "Down"]
    D2 = ["Left", "Right"]
    D3 = ["Forward", "Back"]
    for x in D1:
        for y in D2:
            for z in D3:
                for p0, p1, p2 in itertools.permutations([x, y, z]):
                    name = f"{p0[0]}{p1[0]}{p2[0]}"
                    yield ViewCoordinates(name, p0, p1, p2)


def generate_up_handed_permutations() -> Iterable[ViewCoordinates]:
    return [
        ViewCoordinates(name="RIGHT_HAND_X_UP", axis0="Up", axis1="Right", axis2="Forward"),
        ViewCoordinates(name="RIGHT_HAND_X_DOWN", axis0="Down", axis1="Right", axis2="Back"),
        ViewCoordinates(name="RIGHT_HAND_Y_UP", axis0="Right", axis1="Up", axis2="Back"),
        ViewCoordinates(name="RIGHT_HAND_Y_DOWN", axis0="Right", axis1="Down", axis2="Forward"),
        ViewCoordinates(name="RIGHT_HAND_Z_UP", axis0="Right", axis1="Forward", axis2="Up"),
        ViewCoordinates(name="RIGHT_HAND_Z_DOWN", axis0="Right", axis1="Back", axis2="Down"),
        ViewCoordinates(name="LEFT_HAND_X_UP", axis0="Up", axis1="Right", axis2="Back"),
        ViewCoordinates(name="LEFT_HAND_X_DOWN", axis0="Down", axis1="Right", axis2="Forward"),
        ViewCoordinates(name="LEFT_HAND_Y_UP", axis0="Right", axis1="Up", axis2="Forward"),
        ViewCoordinates(name="LEFT_HAND_Y_DOWN", axis0="Right", axis1="Down", axis2="Back"),
        ViewCoordinates(name="LEFT_HAND_Z_UP", axis0="Right", axis1="Back", axis2="Up"),
        ViewCoordinates(name="LEFT_HAND_Z_DOWN", axis0="Right", axis1="Forward", axis2="Down"),
    ]


################################################################################


def rust_definition(coords: ViewCoordinates) -> str:
    return f"define_coordinates!({coords.name} => ({coords.axis0}, {coords.axis1}, {coords.axis2}));\n"


def gen_rust_definitions() -> list[str]:
    key = "definitions"
    lines = []
    lines.append(f"// {BEGIN_MARKER.format(key)}\n")
    lines.append(f"// This section is generated by running `{SCRIPT_PATH} --rust`\n")
    lines.extend(rust_definition(v) for v in generate_view_permutations())
    lines.extend(rust_definition(v) for v in generate_up_handed_permutations())
    lines.append(f"// {END_MARKER.format(key)}\n")
    return lines


################################################################################


def py_definition(coords: ViewCoordinates) -> str:
    return f"{coords.name} = Component([Component.ViewDir.{coords.axis0}, Component.ViewDir.{coords.axis1}, Component.ViewDir.{coords.axis2}])\n"


def gen_py_definitions() -> list[str]:
    key = "definitions"
    lines = []
    lines.append(f"# {BEGIN_MARKER.format(key)}\n")
    lines.append(f"# This section is generated by running `{SCRIPT_PATH} --python`\n")
    lines.extend(py_definition(v) for v in generate_view_permutations())
    lines.extend(py_definition(v) for v in generate_up_handed_permutations())
    lines.append(f"# {END_MARKER.format(key)}\n")
    lines = [" " * 4 + line for line in lines]
    return lines


################################################################################


def cpp_declaration(coords: ViewCoordinates) -> str:
    return f"static const rerun::archetypes::ViewCoordinates {coords.name};\n"


def gen_cpp_declarations() -> list[str]:
    key = "declarations"
    lines = []
    lines.append(f"// {BEGIN_MARKER.format(key)}\n")
    lines.append(f"// This section is generated by running `{SCRIPT_PATH} --cpp`\n")
    lines.extend(cpp_declaration(v) for v in generate_view_permutations())
    lines.extend(cpp_declaration(v) for v in generate_up_handed_permutations())
    lines.append(f"// {END_MARKER.format(key)}\n")
    lines = [" " * 4 + line for line in lines]
    return lines


def cpp_definition(coords: ViewCoordinates) -> str:
    return (
        f"const ViewCoordinates ViewCoordinates::{coords.name} = ViewCoordinates(\n"
        + f"rerun::components::ViewCoordinates::{coords.axis0}, rerun::components::ViewCoordinates::{coords.axis1}, rerun::components::ViewCoordinates::{coords.axis2}\n"
        + ");\n"
    )


def gen_cpp_definitions() -> list[str]:
    key = "definitions"
    lines = []
    lines.append(f"// {BEGIN_MARKER.format(key)}\n")
    lines.append(f"// This section is generated by running `{SCRIPT_PATH} --cpp`\n")
    lines.extend(cpp_definition(v) for v in generate_view_permutations())
    lines.extend(cpp_definition(v) for v in generate_up_handed_permutations())
    lines.append(f"// {END_MARKER.format(key)}\n")
    lines = [" " * 4 + line for line in lines]
    return lines


################################################################################


def show_preview(lines: list[str]) -> None:
    print("".join(lines))


def patch_file(filename: str, lines: list[str], key: str) -> None:
    contents = open(filename).readlines()
    start_line = next((i for i, line in enumerate(contents) if BEGIN_MARKER.format(key) in line), None)
    end_line = next((i for i, line in enumerate(contents) if END_MARKER.format(key) in line), None)
    if (start_line is None) or (end_line is None):
        raise Exception("Could not find the generated section in the file.")
    new_contents = contents[:start_line] + lines + contents[end_line + 1 :]
    open(filename, "w").writelines(new_contents)


################################################################################


def main() -> None:
    parser = argparse.ArgumentParser(description="Modify the ViewCoordinate archetypes.")
    parser.add_argument(
        "--rust",
        action="store_true",
        default=False,
        help="Generate the rust code for the view coordinates.",
    )
    parser.add_argument(
        "--python",
        action="store_true",
        default=False,
        help="Generate the python code for the view coordinates.",
    )
    parser.add_argument(
        "--cpp",
        action="store_true",
        default=False,
        help="Generate the cpp code for the view coordinates.",
    )
    parser.add_argument(
        "--preview", action="store_true", default=False, help="Just print the preview of the generated sections"
    )
    args = parser.parse_args()

    if args.rust:
        if args.preview:
            show_preview(gen_rust_definitions())
            print("".join(gen_rust_definitions()))
        else:
            patch_file(RUST_EXTENSION_FILE, gen_rust_definitions(), "definitions")

    if args.python:
        if args.preview:
            show_preview(gen_py_definitions())
        else:
            patch_file(PYTHON_EXTENSION_FILE, gen_py_definitions(), "definitions")

    if args.cpp:
        if args.preview:
            print("Declarations:")
            show_preview(gen_cpp_declarations())
            print("\nDefinitions:")
            show_preview(gen_cpp_definitions())
        else:
            patch_file(CPP_EXTENSION_FILE, gen_cpp_declarations(), "declarations")
            patch_file(CPP_EXTENSION_FILE, gen_cpp_definitions(), "definitions")


if __name__ == "__main__":
    main()
