from __future__ import annotations

from typing import TYPE_CHECKING

from inline_snapshot import snapshot as inline_snapshot

if TYPE_CHECKING:
    from rerun_draft.catalog import DatasetEntry


def test_index_statistics(complex_dataset: DatasetEntry) -> None:
    df = complex_dataset.index_statistics("timeline").sort("rerun_segment_id")

    assert str(df) == inline_snapshot("""\
┌────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│ METADATA:                                                                                                                                                                              │
│ * version: 0.1.1                                                                                                                                                                       │
├╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌┤
│ ┌─────────────────────┬──────────────────────────────┬──────────────────────────────┬────────────────────────────────┬───────────────────────────────────┬───────────────────────────┐ │
│ │ rerun_segment_id    ┆ min(timeline)                ┆ max(timeline)                ┆ count(/points:Points2D:colors) ┆ count(/points:Points2D:positions) ┆ count(/text:TextLog:text) │ │
│ │ ---                 ┆ ---                          ┆ ---                          ┆ ---                            ┆ ---                               ┆ ---                       │ │
│ │ type: Utf8          ┆ type: nullable Timestamp(ns) ┆ type: nullable Timestamp(ns) ┆ type: i64                      ┆ type: i64                         ┆ type: i64                 │ │
│ ╞═════════════════════╪══════════════════════════════╪══════════════════════════════╪════════════════════════════════╪═══════════════════════════════════╪═══════════════════════════╡ │
│ │ complex_recording_0 ┆ 2000-01-01T00:00:00          ┆ 2000-01-01T00:00:02          ┆ 1                              ┆ 1                                 ┆ 2                         │ │
│ ├╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌┼╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌┼╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌┼╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌┼╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌┼╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌┤ │
│ │ complex_recording_1 ┆ 2000-01-01T00:00:01          ┆ 2000-01-01T00:00:03          ┆ 1                              ┆ 1                                 ┆ 2                         │ │
│ ├╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌┼╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌┼╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌┼╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌┼╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌┼╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌┤ │
│ │ complex_recording_2 ┆ 2000-01-01T00:00:02          ┆ 2000-01-01T00:00:04          ┆ 1                              ┆ 1                                 ┆ 2                         │ │
│ ├╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌┼╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌┼╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌┼╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌┼╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌┼╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌┤ │
│ │ complex_recording_3 ┆ 2000-01-01T00:00:03          ┆ 2000-01-01T00:00:05          ┆ 1                              ┆ 1                                 ┆ 2                         │ │
│ ├╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌┼╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌┼╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌┼╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌┼╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌┼╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌┤ │
│ │ complex_recording_4 ┆ 2000-01-01T00:00:04          ┆ 2000-01-01T00:00:06          ┆ 1                              ┆ 1                                 ┆ 2                         │ │
│ └─────────────────────┴──────────────────────────────┴──────────────────────────────┴────────────────────────────────┴───────────────────────────────────┴───────────────────────────┘ │
└────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘\
""")


def test_index_statistics_dataset_view(complex_dataset: DatasetEntry) -> None:
    view = complex_dataset.filter_segments(["complex_recording_0", "complex_recording_1"]).filter_contents(["/points"])

    df = view.index_statistics("timeline").sort("rerun_segment_id")

    assert str(df) == inline_snapshot("""\
┌────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│ METADATA:                                                                                                                                                  │
│ * version: 0.1.1                                                                                                                                           │
├╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌┤
│ ┌─────────────────────┬──────────────────────────────┬──────────────────────────────┬────────────────────────────────┬───────────────────────────────────┐ │
│ │ rerun_segment_id    ┆ min(timeline)                ┆ max(timeline)                ┆ count(/points:Points2D:colors) ┆ count(/points:Points2D:positions) │ │
│ │ ---                 ┆ ---                          ┆ ---                          ┆ ---                            ┆ ---                               │ │
│ │ type: Utf8          ┆ type: nullable Timestamp(ns) ┆ type: nullable Timestamp(ns) ┆ type: i64                      ┆ type: i64                         │ │
│ ╞═════════════════════╪══════════════════════════════╪══════════════════════════════╪════════════════════════════════╪═══════════════════════════════════╡ │
│ │ complex_recording_0 ┆ 2000-01-01T00:00:01          ┆ 2000-01-01T00:00:01          ┆ 1                              ┆ 1                                 │ │
│ ├╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌┼╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌┼╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌┼╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌┼╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌╌┤ │
│ │ complex_recording_1 ┆ 2000-01-01T00:00:02          ┆ 2000-01-01T00:00:02          ┆ 1                              ┆ 1                                 │ │
│ └─────────────────────┴──────────────────────────────┴──────────────────────────────┴────────────────────────────────┴───────────────────────────────────┘ │
└────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘\
""")
