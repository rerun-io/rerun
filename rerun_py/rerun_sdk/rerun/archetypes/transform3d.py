# DO NOT EDIT! This file was auto-generated by crates/build/re_types_builder/src/codegen/python/mod.rs
# Based on "crates/store/re_sdk_types/definitions/rerun/archetypes/transform3d.fbs".

# You can extend this class by creating a "Transform3DExt" class in "transform3d_ext.py".

from __future__ import annotations

import numpy as np
import pyarrow as pa
from attrs import define, field

from .. import components, datatypes
from .._baseclasses import (
    Archetype,
    ComponentColumnList,
)
from ..error_utils import catch_and_log_exceptions
from .transform3d_ext import Transform3DExt

__all__ = ["Transform3D"]


@define(str=False, repr=False, init=False)
class Transform3D(Transform3DExt, Archetype):
    """
    **Archetype**: A transform between two 3D spaces, i.e. a pose.

    From the point of view of the entity's coordinate system,
    all components are applied in the inverse order they are listed here.
    E.g. if both a translation and a mat3x3 transform are present,
    the 3x3 matrix is applied first, followed by the translation.

    Whenever you log this archetype, the state of the resulting transform relationship is fully reset to the new archetype.
    This means that if you first log a transform with only a translation, and then log one with only a rotation,
    it will be resolved to a transform with only a rotation.
    (This is unlike how we usually apply latest-at semantics on an archetype where we take the latest state of any component independently)

    For transforms that affect only a single entity and do not propagate along the entity tree refer to [`archetypes.InstancePoses3D`][rerun.archetypes.InstancePoses3D].

    Examples
    --------
    ### Variety of 3D transforms:
    ```python
    from math import pi

    import rerun as rr
    from rerun.datatypes import Angle, RotationAxisAngle

    rr.init("rerun_example_transform3d", spawn=True)

    arrow = rr.Arrows3D(origins=[0, 0, 0], vectors=[0, 1, 0])

    rr.log("base", arrow)

    rr.log("base/translated", rr.Transform3D(translation=[1, 0, 0]))
    rr.log("base/translated", arrow)

    rr.log(
        "base/rotated_scaled",
        rr.Transform3D(
            rotation=RotationAxisAngle(axis=[0, 0, 1], angle=Angle(rad=pi / 4)),
            scale=2,
        ),
    )
    rr.log("base/rotated_scaled", arrow)
    ```
    <center>
    <picture>
      <source media="(max-width: 480px)" srcset="https://static.rerun.io/transform3d_simple/141368b07360ce3fcb1553079258ae3f42bdb9ac/480w.png">
      <source media="(max-width: 768px)" srcset="https://static.rerun.io/transform3d_simple/141368b07360ce3fcb1553079258ae3f42bdb9ac/768w.png">
      <source media="(max-width: 1024px)" srcset="https://static.rerun.io/transform3d_simple/141368b07360ce3fcb1553079258ae3f42bdb9ac/1024w.png">
      <source media="(max-width: 1200px)" srcset="https://static.rerun.io/transform3d_simple/141368b07360ce3fcb1553079258ae3f42bdb9ac/1200w.png">
      <img src="https://static.rerun.io/transform3d_simple/141368b07360ce3fcb1553079258ae3f42bdb9ac/full.png" width="640">
    </picture>
    </center>

    ### Update a transform over time:
    ```python
    import math

    import rerun as rr


    def truncated_radians(deg: float) -> float:
        return float(int(math.radians(deg) * 1000.0)) / 1000.0


    rr.init("rerun_example_transform3d_row_updates", spawn=True)

    rr.set_time("tick", sequence=0)
    rr.log(
        "box",
        rr.Boxes3D(half_sizes=[4.0, 2.0, 1.0], fill_mode=rr.components.FillMode.Solid),
        rr.TransformAxes3D(10.0),
    )

    for t in range(100):
        rr.set_time("tick", sequence=t + 1)
        rr.log(
            "box",
            rr.Transform3D(
                translation=[0, 0, t / 10.0],
                rotation_axis_angle=rr.RotationAxisAngle(axis=[0.0, 1.0, 0.0], radians=truncated_radians(t * 4)),
            ),
        )
    ```
    <center>
    <picture>
      <source media="(max-width: 480px)" srcset="https://static.rerun.io/transform3d_column_updates/80634e1c7c7a505387e975f25ea8b6bc1d4eb9db/480w.png">
      <source media="(max-width: 768px)" srcset="https://static.rerun.io/transform3d_column_updates/80634e1c7c7a505387e975f25ea8b6bc1d4eb9db/768w.png">
      <source media="(max-width: 1024px)" srcset="https://static.rerun.io/transform3d_column_updates/80634e1c7c7a505387e975f25ea8b6bc1d4eb9db/1024w.png">
      <source media="(max-width: 1200px)" srcset="https://static.rerun.io/transform3d_column_updates/80634e1c7c7a505387e975f25ea8b6bc1d4eb9db/1200w.png">
      <img src="https://static.rerun.io/transform3d_column_updates/80634e1c7c7a505387e975f25ea8b6bc1d4eb9db/full.png" width="640">
    </picture>
    </center>

    ### Update a transform over time, in a single operation:
    ```python
    import math

    import rerun as rr


    def truncated_radians(deg: float) -> float:
        return float(int(math.radians(deg) * 1000.0)) / 1000.0


    rr.init("rerun_example_transform3d_column_updates", spawn=True)

    rr.set_time("tick", sequence=0)
    rr.log(
        "box",
        rr.Boxes3D(half_sizes=[4.0, 2.0, 1.0], fill_mode=rr.components.FillMode.Solid),
        rr.TransformAxes3D(10.0),
    )

    rr.send_columns(
        "box",
        indexes=[rr.TimeColumn("tick", sequence=range(1, 101))],
        columns=rr.Transform3D.columns(
            translation=[[0, 0, t / 10.0] for t in range(100)],
            rotation_axis_angle=[
                rr.RotationAxisAngle(axis=[0.0, 1.0, 0.0], radians=truncated_radians(t * 4)) for t in range(100)
            ],
        ),
    )
    ```
    <center>
    <picture>
      <source media="(max-width: 480px)" srcset="https://static.rerun.io/transform3d_column_updates/80634e1c7c7a505387e975f25ea8b6bc1d4eb9db/480w.png">
      <source media="(max-width: 768px)" srcset="https://static.rerun.io/transform3d_column_updates/80634e1c7c7a505387e975f25ea8b6bc1d4eb9db/768w.png">
      <source media="(max-width: 1024px)" srcset="https://static.rerun.io/transform3d_column_updates/80634e1c7c7a505387e975f25ea8b6bc1d4eb9db/1024w.png">
      <source media="(max-width: 1200px)" srcset="https://static.rerun.io/transform3d_column_updates/80634e1c7c7a505387e975f25ea8b6bc1d4eb9db/1200w.png">
      <img src="https://static.rerun.io/transform3d_column_updates/80634e1c7c7a505387e975f25ea8b6bc1d4eb9db/full.png" width="640">
    </picture>
    </center>

    ### Update specific properties of a transform over time:
    ```python
    import math

    import rerun as rr


    def truncated_radians(deg: float) -> float:
        return float(int(math.radians(deg) * 1000.0)) / 1000.0


    rr.init("rerun_example_transform3d_partial_updates", spawn=True)

    # Set up a 3D box.
    rr.log(
        "box",
        rr.Boxes3D(half_sizes=[4.0, 2.0, 1.0], fill_mode=rr.components.FillMode.Solid),
    )

    # Update only the rotation of the box.
    for deg in range(46):
        rad = truncated_radians(deg * 4)
        rr.log(
            "box",
            rr.Transform3D.from_fields(
                rotation_axis_angle=rr.RotationAxisAngle(axis=[0.0, 1.0, 0.0], radians=rad),
            ),
        )

    # Update only the position of the box.
    for t in range(51):
        rr.log(
            "box",
            rr.Transform3D.from_fields(translation=[0, 0, t / 10.0]),
        )

    # Update only the rotation of the box.
    for deg in range(46):
        rad = truncated_radians((deg + 45) * 4)
        rr.log(
            "box",
            rr.Transform3D.from_fields(
                rotation_axis_angle=rr.RotationAxisAngle(axis=[0.0, 1.0, 0.0], radians=rad),
            ),
        )

    # Clear all of the box's attributes.
    rr.log(
        "box",
        rr.Transform3D.from_fields(clear_unset=True),
    )
    ```
    <center>
    <picture>
      <source media="(max-width: 480px)" srcset="https://static.rerun.io/transform3d_partial_updates/11815bebc69ae400847896372b496cdd3e9b19fb/480w.png">
      <source media="(max-width: 768px)" srcset="https://static.rerun.io/transform3d_partial_updates/11815bebc69ae400847896372b496cdd3e9b19fb/768w.png">
      <source media="(max-width: 1024px)" srcset="https://static.rerun.io/transform3d_partial_updates/11815bebc69ae400847896372b496cdd3e9b19fb/1024w.png">
      <source media="(max-width: 1200px)" srcset="https://static.rerun.io/transform3d_partial_updates/11815bebc69ae400847896372b496cdd3e9b19fb/1200w.png">
      <img src="https://static.rerun.io/transform3d_partial_updates/11815bebc69ae400847896372b496cdd3e9b19fb/full.png" width="640">
    </picture>
    </center>

    """

    # __init__ can be found in transform3d_ext.py

    def __attrs_clear__(self) -> None:
        """Convenience method for calling `__attrs_init__` with all `None`s."""
        self.__attrs_init__(
            translation=None,
            rotation_axis_angle=None,
            quaternion=None,
            scale=None,
            mat3x3=None,
            relation=None,
            child_frame=None,
            parent_frame=None,
        )

    @classmethod
    def _clear(cls) -> Transform3D:
        """Produce an empty Transform3D, bypassing `__init__`."""
        inst = cls.__new__(cls)
        inst.__attrs_clear__()
        return inst

    @classmethod
    def from_fields(
        cls,
        *,
        clear_unset: bool = False,
        translation: datatypes.Vec3DLike | None = None,
        rotation_axis_angle: datatypes.RotationAxisAngleLike | None = None,
        quaternion: datatypes.QuaternionLike | None = None,
        scale: datatypes.Vec3DLike | None = None,
        mat3x3: datatypes.Mat3x3Like | None = None,
        relation: components.TransformRelationLike | None = None,
        child_frame: datatypes.Utf8Like | None = None,
        parent_frame: datatypes.Utf8Like | None = None,
    ) -> Transform3D:
        """
        Update only some specific fields of a `Transform3D`.

        Parameters
        ----------
        clear_unset:
            If true, all unspecified fields will be explicitly cleared.
        translation:
            Translation vector.

            Any update to this field will reset all other transform properties that aren't changed in the same log call or `send_columns` row.
        rotation_axis_angle:
            Rotation via axis + angle.

            Any update to this field will reset all other transform properties that aren't changed in the same log call or `send_columns` row.
        quaternion:
            Rotation via quaternion.

            Any update to this field will reset all other transform properties that aren't changed in the same log call or `send_columns` row.
        scale:
            Scaling factor.

            Any update to this field will reset all other transform properties that aren't changed in the same log call or `send_columns` row.
        mat3x3:
            3x3 transformation matrix.

            Any update to this field will reset all other transform properties that aren't changed in the same log call or `send_columns` row.
        relation:
            Specifies the relation this transform establishes between this entity and its parent.

            Any update to this field will reset all other transform properties that aren't changed in the same log call or `send_columns` row.
        child_frame:
            The child frame this transform transforms from.

            The entity at which the transform relationship of any given child frame is specified mustn't change over time, but is allowed to be different for static time.
            E.g. if you specified the child frame `"robot_arm"` on an entity named `"my_transforms"`, you may not log transforms
            with the child frame `"robot_arm"` on any other entity than `"my_transforms"` unless one of them was logged with static time.

            If not specified, this is set to the implicit transform frame of the current entity path.
            This means that if a [`archetypes.Transform3D`][rerun.archetypes.Transform3D] is set on an entity called `/my/entity/path` then this will default to `tf#/my/entity/path`.

            To set the frame an entity is part of see [`archetypes.CoordinateFrame`][rerun.archetypes.CoordinateFrame].

            Any update to this field will reset all other transform properties that aren't changed in the same log call or `send_columns` row.
        parent_frame:
            The parent frame this transform transforms into.

            If not specified, this is set to the implicit transform frame of the current entity path's parent.
            This means that if a [`archetypes.Transform3D`][rerun.archetypes.Transform3D] is set on an entity called `/my/entity/path` then this will default to `tf#/my/entity`.

            To set the frame an entity is part of see [`archetypes.CoordinateFrame`][rerun.archetypes.CoordinateFrame].

            Any update to this field will reset all other transform properties that aren't changed in the same log call or `send_columns` row.

        """

        inst = cls.__new__(cls)
        with catch_and_log_exceptions(context=cls.__name__):
            kwargs = {
                "translation": translation,
                "rotation_axis_angle": rotation_axis_angle,
                "quaternion": quaternion,
                "scale": scale,
                "mat3x3": mat3x3,
                "relation": relation,
                "child_frame": child_frame,
                "parent_frame": parent_frame,
            }

            if clear_unset:
                kwargs = {k: v if v is not None else [] for k, v in kwargs.items()}  # type: ignore[misc]

            inst.__attrs_init__(**kwargs)
            return inst

        inst.__attrs_clear__()
        return inst

    @classmethod
    def cleared(cls) -> Transform3D:
        """Clear all the fields of a `Transform3D`."""
        return cls.from_fields(clear_unset=True)

    @classmethod
    def columns(
        cls,
        *,
        translation: datatypes.Vec3DArrayLike | None = None,
        rotation_axis_angle: datatypes.RotationAxisAngleArrayLike | None = None,
        quaternion: datatypes.QuaternionArrayLike | None = None,
        scale: datatypes.Vec3DArrayLike | None = None,
        mat3x3: datatypes.Mat3x3ArrayLike | None = None,
        relation: components.TransformRelationArrayLike | None = None,
        child_frame: datatypes.Utf8ArrayLike | None = None,
        parent_frame: datatypes.Utf8ArrayLike | None = None,
    ) -> ComponentColumnList:
        """
        Construct a new column-oriented component bundle.

        This makes it possible to use `rr.send_columns` to send columnar data directly into Rerun.

        The returned columns will be partitioned into unit-length sub-batches by default.
        Use `ComponentColumnList.partition` to repartition the data as needed.

        Parameters
        ----------
        translation:
            Translation vector.

            Any update to this field will reset all other transform properties that aren't changed in the same log call or `send_columns` row.
        rotation_axis_angle:
            Rotation via axis + angle.

            Any update to this field will reset all other transform properties that aren't changed in the same log call or `send_columns` row.
        quaternion:
            Rotation via quaternion.

            Any update to this field will reset all other transform properties that aren't changed in the same log call or `send_columns` row.
        scale:
            Scaling factor.

            Any update to this field will reset all other transform properties that aren't changed in the same log call or `send_columns` row.
        mat3x3:
            3x3 transformation matrix.

            Any update to this field will reset all other transform properties that aren't changed in the same log call or `send_columns` row.
        relation:
            Specifies the relation this transform establishes between this entity and its parent.

            Any update to this field will reset all other transform properties that aren't changed in the same log call or `send_columns` row.
        child_frame:
            The child frame this transform transforms from.

            The entity at which the transform relationship of any given child frame is specified mustn't change over time, but is allowed to be different for static time.
            E.g. if you specified the child frame `"robot_arm"` on an entity named `"my_transforms"`, you may not log transforms
            with the child frame `"robot_arm"` on any other entity than `"my_transforms"` unless one of them was logged with static time.

            If not specified, this is set to the implicit transform frame of the current entity path.
            This means that if a [`archetypes.Transform3D`][rerun.archetypes.Transform3D] is set on an entity called `/my/entity/path` then this will default to `tf#/my/entity/path`.

            To set the frame an entity is part of see [`archetypes.CoordinateFrame`][rerun.archetypes.CoordinateFrame].

            Any update to this field will reset all other transform properties that aren't changed in the same log call or `send_columns` row.
        parent_frame:
            The parent frame this transform transforms into.

            If not specified, this is set to the implicit transform frame of the current entity path's parent.
            This means that if a [`archetypes.Transform3D`][rerun.archetypes.Transform3D] is set on an entity called `/my/entity/path` then this will default to `tf#/my/entity`.

            To set the frame an entity is part of see [`archetypes.CoordinateFrame`][rerun.archetypes.CoordinateFrame].

            Any update to this field will reset all other transform properties that aren't changed in the same log call or `send_columns` row.

        """

        inst = cls.__new__(cls)
        with catch_and_log_exceptions(context=cls.__name__):
            inst.__attrs_init__(
                translation=translation,
                rotation_axis_angle=rotation_axis_angle,
                quaternion=quaternion,
                scale=scale,
                mat3x3=mat3x3,
                relation=relation,
                child_frame=child_frame,
                parent_frame=parent_frame,
            )

        batches = inst.as_component_batches()
        if len(batches) == 0:
            return ComponentColumnList([])

        kwargs = {
            "Transform3D:translation": translation,
            "Transform3D:rotation_axis_angle": rotation_axis_angle,
            "Transform3D:quaternion": quaternion,
            "Transform3D:scale": scale,
            "Transform3D:mat3x3": mat3x3,
            "Transform3D:relation": relation,
            "Transform3D:child_frame": child_frame,
            "Transform3D:parent_frame": parent_frame,
        }
        columns = []

        for batch in batches:
            arrow_array = batch.as_arrow_array()

            # For primitive arrays and fixed size list arrays, we infer partition size from the input shape.
            if pa.types.is_primitive(arrow_array.type) or pa.types.is_fixed_size_list(arrow_array.type):
                param = kwargs[batch.component_descriptor().component]  # type: ignore[index]
                shape = np.shape(param)  # type: ignore[arg-type]
                elem_flat_len = int(np.prod(shape[1:])) if len(shape) > 1 else 1  # type: ignore[redundant-expr,misc]

                if pa.types.is_fixed_size_list(arrow_array.type) and arrow_array.type.list_size == elem_flat_len:
                    # If the product of the last dimensions of the shape are equal to the size of the fixed size list array,
                    # we have `num_rows` single element batches (each element is a fixed sized list).
                    # (This should have been already validated by conversion to the arrow_array)
                    batch_length = 1
                else:
                    batch_length = shape[1] if len(shape) > 1 else 1  # type: ignore[redundant-expr,misc]

                num_rows = shape[0] if len(shape) >= 1 else 1  # type: ignore[redundant-expr,misc]
                sizes = batch_length * np.ones(num_rows)
            else:
                # For non-primitive types, default to partitioning each element separately.
                sizes = np.ones(len(arrow_array))

            columns.append(batch.partition(sizes))

        return ComponentColumnList(columns)

    translation: components.Translation3DBatch | None = field(
        metadata={"component": True},
        default=None,
        converter=components.Translation3DBatch._converter,  # type: ignore[misc]
    )
    # Translation vector.
    #
    # Any update to this field will reset all other transform properties that aren't changed in the same log call or `send_columns` row.
    #
    # (Docstring intentionally commented out to hide this field from the docs)

    rotation_axis_angle: components.RotationAxisAngleBatch | None = field(
        metadata={"component": True},
        default=None,
        converter=components.RotationAxisAngleBatch._converter,  # type: ignore[misc]
    )
    # Rotation via axis + angle.
    #
    # Any update to this field will reset all other transform properties that aren't changed in the same log call or `send_columns` row.
    #
    # (Docstring intentionally commented out to hide this field from the docs)

    quaternion: components.RotationQuatBatch | None = field(
        metadata={"component": True},
        default=None,
        converter=components.RotationQuatBatch._converter,  # type: ignore[misc]
    )
    # Rotation via quaternion.
    #
    # Any update to this field will reset all other transform properties that aren't changed in the same log call or `send_columns` row.
    #
    # (Docstring intentionally commented out to hide this field from the docs)

    scale: components.Scale3DBatch | None = field(
        metadata={"component": True},
        default=None,
        converter=components.Scale3DBatch._converter,  # type: ignore[misc]
    )
    # Scaling factor.
    #
    # Any update to this field will reset all other transform properties that aren't changed in the same log call or `send_columns` row.
    #
    # (Docstring intentionally commented out to hide this field from the docs)

    mat3x3: components.TransformMat3x3Batch | None = field(
        metadata={"component": True},
        default=None,
        converter=components.TransformMat3x3Batch._converter,  # type: ignore[misc]
    )
    # 3x3 transformation matrix.
    #
    # Any update to this field will reset all other transform properties that aren't changed in the same log call or `send_columns` row.
    #
    # (Docstring intentionally commented out to hide this field from the docs)

    relation: components.TransformRelationBatch | None = field(
        metadata={"component": True},
        default=None,
        converter=components.TransformRelationBatch._converter,  # type: ignore[misc]
    )
    # Specifies the relation this transform establishes between this entity and its parent.
    #
    # Any update to this field will reset all other transform properties that aren't changed in the same log call or `send_columns` row.
    #
    # (Docstring intentionally commented out to hide this field from the docs)

    child_frame: components.TransformFrameIdBatch | None = field(
        metadata={"component": True},
        default=None,
        converter=components.TransformFrameIdBatch._converter,  # type: ignore[misc]
    )
    # The child frame this transform transforms from.
    #
    # The entity at which the transform relationship of any given child frame is specified mustn't change over time, but is allowed to be different for static time.
    # E.g. if you specified the child frame `"robot_arm"` on an entity named `"my_transforms"`, you may not log transforms
    # with the child frame `"robot_arm"` on any other entity than `"my_transforms"` unless one of them was logged with static time.
    #
    # If not specified, this is set to the implicit transform frame of the current entity path.
    # This means that if a [`archetypes.Transform3D`][rerun.archetypes.Transform3D] is set on an entity called `/my/entity/path` then this will default to `tf#/my/entity/path`.
    #
    # To set the frame an entity is part of see [`archetypes.CoordinateFrame`][rerun.archetypes.CoordinateFrame].
    #
    # Any update to this field will reset all other transform properties that aren't changed in the same log call or `send_columns` row.
    #
    # (Docstring intentionally commented out to hide this field from the docs)

    parent_frame: components.TransformFrameIdBatch | None = field(
        metadata={"component": True},
        default=None,
        converter=components.TransformFrameIdBatch._converter,  # type: ignore[misc]
    )
    # The parent frame this transform transforms into.
    #
    # If not specified, this is set to the implicit transform frame of the current entity path's parent.
    # This means that if a [`archetypes.Transform3D`][rerun.archetypes.Transform3D] is set on an entity called `/my/entity/path` then this will default to `tf#/my/entity`.
    #
    # To set the frame an entity is part of see [`archetypes.CoordinateFrame`][rerun.archetypes.CoordinateFrame].
    #
    # Any update to this field will reset all other transform properties that aren't changed in the same log call or `send_columns` row.
    #
    # (Docstring intentionally commented out to hide this field from the docs)

    __str__ = Archetype.__str__
    __repr__ = Archetype.__repr__  # type: ignore[assignment]
