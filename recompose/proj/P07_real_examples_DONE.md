# P07: Real Examples

**Goal:** Create real, working examples that serve the recompose project itself. These become
the actual CI/dev workflow for recompose, demonstrating that the system works end-to-end.

## Background

The current examples are haphazard - based on development order rather than serving as an
optimal introduction to using recompose. We want:

1. Real tasks that actually do useful things for the recompose project
2. A unified `recompose/run` entrypoint that becomes THE way to run tasks
3. Generated workflows that run in actual CI
4. Validation that workflows stay in sync

## Phases

### P07a - Examples structure & basic tasks

**Tasks to create:**
- `lint` - Run `ruff check` on the codebase
- `format-check` - Run `ruff format --check` (for CI)
- `format` - Run `ruff format` (apply fixes, local only)
- `typecheck` - Run `mypy` (if configured)
- `test` - Run `pytest`

**Structure:**
```
examples/
├── README.md          # Explains the examples
├── tasks/
│   ├── __init__.py
│   ├── lint.py        # lint, format-check, format tasks
│   └── test.py        # test task
└── ...
```

**Completion:** Can run `./run lint`, `./run test` etc.

### P07b - Build & distribution tasks

**Tasks to create:**
- `build-wheel` - Build the wheel with `uv build`
- `create-venv` - Create a test virtualenv
- `install-wheel` - Install wheel into venv
- `test-installed` - Run tests against installed package

**Flow:**
```python
@recompose.flow
def test_wheel_flow():
    """Build wheel, install in fresh venv, run tests."""
    gha.checkout.flow()
    gha.setup_python().flow()
    gha.setup_uv().flow()

    wheel = build_wheel.flow()
    venv = create_venv.flow()
    install_wheel.flow(venv=venv, wheel=wheel)
    test_installed.flow(venv=venv)
```

**Completion:** Can build and test wheel locally and generate workflow for it.

### P07c - Unified entrypoint

**Create `recompose/run`:**
```python
#!/usr/bin/env python3
"""Recompose task runner - the single entrypoint for all recompose tasks."""

import recompose
from examples.tasks import lint, test, build
# ... import all task modules

recompose.main()
```

Make it executable, add to PATH or use as `./run <task>`.

**Completion:** Single `./run` script runs any task.

### P07d - Workflow generation & validation

**Generated workflow header:**
```yaml
# ============================================================================
# GENERATED FILE - DO NOT EDIT MANUALLY
#
# Generated by: recompose
# Source: examples/flows/ci.py::ci_flow
# Regenerate with: ./run generate-gha ci_flow --output .github/workflows/ci.yml
# ============================================================================
name: ci_flow
...
```

**Validation task:**
```python
@recompose.task
def validate_workflows() -> recompose.Result[None]:
    """Check that committed workflows match generated output."""
    # For each known flow/automation:
    #   1. Generate to temp file
    #   2. Compare with committed file
    #   3. Fail if different
```

**CI flow includes this task** - so manual edits to workflows cause CI failure.

**Completion:** Workflows have headers, validation task works.

## Implementation Notes

### Directory structure after P07:
```
recompose/
├── run                      # Unified entrypoint (executable)
├── examples/
│   ├── README.md
│   ├── tasks/
│   │   ├── __init__.py
│   │   ├── lint.py
│   │   ├── test.py
│   │   └── build.py
│   ├── flows/
│   │   ├── __init__.py
│   │   └── ci.py
│   └── automations/
│       ├── __init__.py
│       └── main.py
├── .github/workflows/       # Or sync to top-level .github/
│   └── ci.yml              # Generated
└── ...
```

### Key design decisions:

1. **Real tasks** - These actually run ruff, pytest, uv build, etc.
2. **Sync to .github/workflows/** - Workflows go to top-level repo's .github/workflows/
3. **Header comments** - All generated YAML has header explaining it's generated
4. **Validation in CI** - Workflow validation runs as part of CI

### Generated workflow location

Since GHA requires workflows in `.github/workflows/`, we sync there. Options:
- Generate directly to `../../.github/workflows/` (relative to recompose/)
- Have a sync task that copies from local to top-level

Going with direct generation to the right location, with paths configurable.

## Open Questions

- Should we have separate lint/format-check or combine into one task with flag?
- How to handle the path to top-level .github/workflows/ cleanly?
- Should validate-workflows be a task or a flow?

## Dependencies

- P06 (GHA generation) - Complete
- ruff, pytest installed in dev environment
