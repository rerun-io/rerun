//! Finds all the `*.rs` files in `docs/code-examples/all`,
//! copies them to `src/examples` (with slight modifications), and generate a `examples/mod.rs` for them.
//!
//! The reason we combine all the examples into a single binary
//! is to reduce the amount of binaries in our workspace.
//!
//! Motivation: <https://github.com/rerun-io/rerun/issues/4623>

use std::{fs, path::Path};

use itertools::Itertools as _;
use rust_format::Formatter as _;

fn main() {
    let crate_path =
        Path::new(&re_build_tools::get_and_track_env_var("CARGO_MANIFEST_DIR").unwrap()).to_owned();
    let all_path = crate_path.join("all");
    let src_path = crate_path.join("src");
    let examples_path = src_path.join("examples");

    assert!(
        all_path.exists() && all_path.is_dir(),
        "Failed to find {all_path:?}"
    );

    let mut examples = Vec::new();

    for entry in fs::read_dir(&all_path).unwrap().flatten() {
        let path = entry.path();
        if let Some(extension) = path.extension() {
            if extension == "rs" {
                let example_name = path.file_stem().unwrap().to_str().unwrap().to_owned();

                let contents = fs::read_to_string(&path).unwrap();

                // TODO(#515): some examples lack a main, they should come with their necessary stub code commented out so that we can re-add it here.
                if contents.contains("fn main()") {
                    // Patch the source code so we can call into `main` and pass arguments to it:
                    let contents = contents.replace("fn main()", "pub fn main(_args: &[String])");
                    let contents = contents.replace(
                        "let args = std::env::args().collect::<Vec<_>>();",
                        "let args = _args;",
                    );

                    let target_path = examples_path.join(format!("{example_name}.rs"));
                    re_build_tools::write_file_if_necessary(target_path, contents.as_bytes())
                        .unwrap();

                    examples.push(example_name);
                }
            }
        }
    }

    assert!(
        examples.len() > 10,
        "Found too few examples in {all_path:?}"
    );

    let source = r#"
    //! DO NOT EDIT! Code generated by ${FILE}.

    ${MODS}

    pub fn run() {
        let args: Vec<String> = std::env::args().skip(1).collect();

        if args.is_empty() {
            eprintln!("Usage: {} <example-name>\n", std::env::args().next().unwrap());
            eprintln!("Available examples ${EXAMPLES}:\n");
            std::process::exit(1);
        }

        let example_name = args[0].as_str();

        match example_name {
            ${MATCH_EXAMPLES}
            _ => {
                eprintln!("Unknown example: {example_name}");
                std::process::exit(1);
            }
        }
    }
    "#
    .trim()
    .replace("${FILE}", file!())
    .replace(
        "${MODS}",
        &examples.iter().map(|m| format!("mod {m};")).join("\n"),
    )
    .replace("${EXAMPLES}", &examples.iter().join(" "))
    .replace(
        "${MATCH_EXAMPLES}",
        &examples
            .iter()
            .map(|m| {
                format!(
                    r#"{m:?} => {{
                        if let Err(err) = {m}::main(&args) {{
                            panic!("Failed to run '{m}': {{err}}");
                        }}
                    }}"#
                )
            })
            .join(",\n"),
    );

    let source = rust_format::RustFmt::default()
        .format_str(source)
        .expect("Failed to format");

    re_build_tools::write_file_if_necessary(examples_path.join("mod.rs"), source.as_bytes())
        .unwrap();
}
